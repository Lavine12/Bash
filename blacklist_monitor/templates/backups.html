{% extends 'base.html' %}
{% block content %}
<h1>Backups</h1>
<p>Recent status:
{% if last_backup %}
    {{ last_backup[1] }} - {{ last_backup[2] }}{% if last_backup[3] %} ({{ last_backup[3] }}){% endif %}
{% else %}
    No backups
{% endif %}
</p>
<form method="post">
    <input type="hidden" name="action" value="create">
    <button type="submit">Run Backup Now</button>
</form>
<h2>Schedule</h2>
<form method="post" id="schedule-form">
    <input type="hidden" name="action" value="schedule_add">
    {% if edit_schedule %}
    <input type="hidden" name="schedule_id" value="{{ edit_schedule.id }}">
    {% endif %}
    <label>Group:</label>
    <select name="group_id" class="wide-select">
        <option value="">All Groups</option>
        {% for g in groups %}
        <option value="{{ g[0] }}" {% if edit_schedule and g[0]==edit_schedule.group_id %}selected{% endif %}>{{ g[1] }}</option>
        {% endfor %}
    </select>
    <label>Type:</label>
    <select name="type" id="schedule-type" class="wide-select" onchange="updateScheduleInputs()">
        <option value="daily" {% if edit_schedule and edit_schedule.type=='daily' %}selected{% endif %}>Daily</option>
        <option value="weekly" {% if edit_schedule and edit_schedule.type=='weekly' %}selected{% endif %}>Weekly</option>
        <option value="monthly" {% if edit_schedule and edit_schedule.type=='monthly' %}selected{% endif %}>Monthly</option>
    </select>
    <span id="day-weekly">
        <select name="day" class="wide-select">
            <option value="mon" {% if edit_schedule and edit_schedule.type=='weekly' and edit_schedule.day=='mon' %}selected{% endif %}>Mon</option>
            <option value="tue" {% if edit_schedule and edit_schedule.type=='weekly' and edit_schedule.day=='tue' %}selected{% endif %}>Tue</option>
            <option value="wed" {% if edit_schedule and edit_schedule.type=='weekly' and edit_schedule.day=='wed' %}selected{% endif %}>Wed</option>
            <option value="thu" {% if edit_schedule and edit_schedule.type=='weekly' and edit_schedule.day=='thu' %}selected{% endif %}>Thu</option>
            <option value="fri" {% if edit_schedule and edit_schedule.type=='weekly' and edit_schedule.day=='fri' %}selected{% endif %}>Fri</option>
            <option value="sat" {% if edit_schedule and edit_schedule.type=='weekly' and edit_schedule.day=='sat' %}selected{% endif %}>Sat</option>
            <option value="sun" {% if edit_schedule and edit_schedule.type=='weekly' and edit_schedule.day=='sun' %}selected{% endif %}>Sun</option>
        </select>
    </span>
    <span id="day-monthly">
        <input type="date" name="day" class="telegram-time-input" {% if edit_schedule and edit_schedule.type=='monthly' %}value="{{ edit_schedule.date_value }}"{% endif %}>
    </span>
    <label>Time:</label>
    <input type="number" name="hour" min="1" max="12" class="telegram-time-input" {% if edit_schedule %}value="{{ edit_schedule.hour }}"{% endif %}>
    <input type="number" name="minute" min="0" max="59" class="telegram-time-input" {% if edit_schedule %}value="{{ edit_schedule.minute }}"{% endif %}>
    <select name="ampm" class="telegram-input">
        <option value="am" {% if edit_schedule and edit_schedule.ampm=='am' %}selected{% endif %}>AM</option>
        <option value="pm" {% if edit_schedule and edit_schedule.ampm=='pm' %}selected{% endif %}>PM</option>
    </select>
    <button type="submit">{% if edit_schedule %}Update{% else %}Add{% endif %}</button>
    {% if edit_schedule %}<a href="{{ url_for('backups_view') }}">Cancel</a>{% endif %}
</form>
<form method="post" id="schedule-delete-form">
    <input type="hidden" name="action" value="schedule_delete">
    <div class="action-buttons">
        <button type="submit">Delete Selected</button>
    </div>
    <table>
        <tr><th><input type="checkbox" onclick="toggleAll(this)"></th><th>Group</th><th>Type</th><th>Day</th><th>Time</th><th>Edit</th></tr>
        {% for s in schedules %}
        <tr>
            <td><input type="checkbox" name="schedule_id" value="{{ s[0] }}"></td>
            <td>{{ s[1] or 'All' }}</td>
            <td>{{ s[2] }}</td>
            <td>{{ s[3] }}</td>
            <td>{{ s[4] }}</td>
            <td><a href="{{ url_for('backups_view', edit=s[0]) }}">Edit</a></td>
        </tr>
        {% endfor %}
    </table>
</form>
<h2>Retention</h2>
<form method="post">
    <input type="hidden" name="action" value="retention">
    <label>Keep days:</label>
    <input type="number" name="days" value="{{ retention_days }}" min="0" class="telegram-input">
    <input type="submit" value="Save">
</form>
<h2>Existing Backups</h2>
<form method="post">
    <input type="hidden" name="action" value="delete">
    <div class="action-buttons">
        <button type="submit">Delete Selected</button>
    </div>
    <table>
        <tr><th><input type="checkbox" onclick="toggleAll(this)"></th><th>ID</th><th>Date</th><th>Status</th><th>Error</th></tr>
        {% for b in backups %}
        <tr>
            <td><input type="checkbox" name="backup_id" value="{{ b[0] }}"></td>
            <td>{{ b[0] }}</td>
            <td>{{ b[1] }}</td>
            <td>{{ b[2] }}</td>
            <td>{{ b[3] }}</td>
        </tr>
        {% endfor %}
    </table>
</form>
<h2>Search</h2>
<form method="get">
    <label>From:</label>
    <input type="date" name="start" value="{{ request.args.start }}" class="telegram-input">
    <label>To:</label>
    <input type="date" name="end" value="{{ request.args.end }}" class="telegram-input">
    <label>IP:</label>
    <input type="text" name="ip" value="{{ request.args.ip }}" class="telegram-input">
    <label>DNSBL:</label>
    <input type="text" name="dnsbl" value="{{ request.args.dnsbl }}" class="telegram-input">
    <label>Listed:</label>
    <select name="listed" class="wide-select">
        <option value="" {% if request.args.listed == '' %}selected{% endif %}></option>
        <option value="1" {% if request.args.listed == '1' %}selected{% endif %}>Yes</option>
        <option value="0" {% if request.args.listed == '0' %}selected{% endif %}>No</option>
    </select>
    <input type="submit" value="Search">
</form>
{% if results %}
<table>
<tr><th>Date</th><th>IP</th><th>DNSBL</th><th>Listed</th><th>Checked At</th></tr>
{% for r in results %}
<tr>
    <td>{{ r[0] }}</td>
    <td>{{ r[1] }}</td>
    <td>{{ r[2] }}</td>
    <td>{{ 'yes' if r[3] else 'no' }}</td>
    <td>{{ r[4] }}</td>
</tr>
{% endfor %}
</table>
{% endif %}
{% endblock %}

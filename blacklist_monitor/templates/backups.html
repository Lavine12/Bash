{% extends 'base.html' %}
{% block content %}
<h1>Backups</h1>
<p>Recent status:
{% if last_backup %}
    {{ last_backup[1] }} - {{ last_backup[2] }}{% if last_backup[3] %} ({{ last_backup[3] }}){% endif %}
{% else %}
    No backups
{% endif %}
</p>
<form method="post">
    <input type="hidden" name="action" value="create">
    <button type="submit">Run Backup Now</button>
</form>
<h2>Schedule</h2>
<form method="post" id="schedule-form">
    <input type="hidden" name="action" value="schedule_add">
    <label>Group:</label>
    <select name="group_id" class="wide-select">
        <option value="">All Groups</option>
        {% for g in groups %}
        <option value="{{ g[0] }}">{{ g[1] }}</option>
        {% endfor %}
    </select>
    <label>Type:</label>
    <select name="type" id="schedule-type" class="wide-select" onchange="updateScheduleInputs()">
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
    </select>
    <span id="day-weekly">
        <select name="day" class="wide-select">
            <option value="mon">Mon</option>
            <option value="tue">Tue</option>
            <option value="wed">Wed</option>
            <option value="thu">Thu</option>
            <option value="fri">Fri</option>
            <option value="sat">Sat</option>
            <option value="sun">Sun</option>
        </select>
    </span>
    <span id="day-monthly">
        <input type="number" name="day" min="1" max="31" class="telegram-time-input">
    </span>
    <label>Time:</label>
    <input type="number" name="hour" min="1" max="12" class="telegram-time-input">
    <input type="number" name="minute" min="0" max="59" class="telegram-time-input">
    <select name="ampm" class="telegram-input">
        <option value="am">AM</option>
        <option value="pm">PM</option>
    </select>
    <button type="submit">Add</button>
</form>
<form method="post">
    <input type="hidden" name="action" value="schedule_delete">
    <div class="action-buttons">
        <button type="submit">Delete Selected</button>
    </div>
    <table>
        <tr><th><input type="checkbox" onclick="toggleAll(this)"></th><th>Group</th><th>Type</th><th>Day</th><th>Time</th></tr>
        {% for s in schedules %}
        <tr>
            <td><input type="checkbox" name="schedule_id" value="{{ s[0] }}"></td>
            <td>{{ s[1] or 'All' }}</td>
            <td>{{ s[2] }}</td>
            <td>{{ s[3] }}</td>
            <td>{{ s[4] }}</td>
        </tr>
        {% endfor %}
    </table>
</form>
<h2>Retention</h2>
<form method="post">
    <input type="hidden" name="action" value="retention">
    <label>Keep days:</label>
    <input type="number" name="days" value="{{ retention_days }}" min="0" class="telegram-input">
    <input type="submit" value="Save">
</form>
<h2>Existing Backups</h2>
<form method="post">
    <input type="hidden" name="action" value="delete">
    <div class="action-buttons">
        <button type="submit">Delete Selected</button>
    </div>
    <table>
        <tr><th><input type="checkbox" onclick="toggleAll(this)"></th><th>ID</th><th>Date</th><th>Status</th><th>Error</th></tr>
        {% for b in backups %}
        <tr>
            <td><input type="checkbox" name="backup_id" value="{{ b[0] }}"></td>
            <td>{{ b[0] }}</td>
            <td>{{ b[1] }}</td>
            <td>{{ b[2] }}</td>
            <td>{{ b[3] }}</td>
        </tr>
        {% endfor %}
    </table>
</form>
<h2>Search</h2>
<form method="get">
    <label>From:</label>
    <input type="date" name="start" value="{{ request.args.start }}" class="telegram-input">
    <label>To:</label>
    <input type="date" name="end" value="{{ request.args.end }}" class="telegram-input">
    <label>IP:</label>
    <input type="text" name="ip" value="{{ request.args.ip }}" class="telegram-input">
    <label>DNSBL:</label>
    <input type="text" name="dnsbl" value="{{ request.args.dnsbl }}" class="telegram-input">
    <label>Listed:</label>
    <select name="listed" class="wide-select">
        <option value="" {% if request.args.listed == '' %}selected{% endif %}></option>
        <option value="1" {% if request.args.listed == '1' %}selected{% endif %}>Yes</option>
        <option value="0" {% if request.args.listed == '0' %}selected{% endif %}>No</option>
    </select>
    <input type="submit" value="Search">
</form>
{% if results %}
<table>
<tr><th>Date</th><th>IP</th><th>DNSBL</th><th>Listed</th><th>Checked At</th></tr>
{% for r in results %}
<tr>
    <td>{{ r[0] }}</td>
    <td>{{ r[1] }}</td>
    <td>{{ r[2] }}</td>
    <td>{{ 'yes' if r[3] else 'no' }}</td>
    <td>{{ r[4] }}</td>
</tr>
{% endfor %}
</table>
{% endif %}
{% endblock %}
